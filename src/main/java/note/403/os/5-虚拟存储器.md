[TOC]

# 第五章 虚拟存储器

## 5.1 虚拟存储器概述

### 5.1.1 传统存储器管理方式的特征和局部性原理

1. 传统存储器管理方式的特征：
   * 一次性：指作业必须一次性地全部装入内存后方能运行；
   * 常驻性：指作业被装入内存后，整个作业都一直驻留在内存中，其中任何部分都不会被换出，直至结束；
2. 局部性原理：程序在执行时将呈现出局部性规律，即在一较短的时间内，程序的执行仅局限于某个部分；
   * 时间局限性：
     * 如果程序中某条指令被执行，则不久后该指令可能再次被执行；如果某数据被访问过，则不久后该数据可能再次被访问；
     * 典型原因：循环操作；
   * 空间局限性：
     * 一旦程序访问了某存储单元，不久之后，其附近的存储单元也将被访问；
     * 典型原因：顺序操作；
3. 虚拟存储器的基本工作情况
   * 基于**离散分配内存管理方式**，采用分页或分段管理；
   * 将程序的部分页面装入内存运行，其余部分驻留在磁盘上；
   * 若程序要访问的页面不在内存中，发出**缺页中断请求**；
   * 若内存未满，OS将利用**请求调页功能**将其调入内存；
   * 若内存已满，OS先利用**页面置换功能**，将内存中暂时不用的页面调出，然后再调入；



### 5.1.2 虚拟存储器的定义和特征

1. 定义：指具有请求调入功能和置换功能，能从逻辑上对内存容量加以扩充的一种虚拟存储系统；

   (其逻辑容量由内存容量与外存容量之和决定，其运行速度接近于内存速度，而每位成本又接近外存。)

2. 特征：

   * 多次性(一次性)：
     * 指一个作业中的程序与数据无须在作业运行时一次性地全部装入内存，允许被分成多次调入内存；
   * 对换性(常驻性)：
     * 指一个作业中的程序与数据无须在作业运行时一直常驻内存，允许在作业运行过程中换入、换出；
   * 虚拟性：
     * 指能够从逻辑上扩充内存容量，使用户所看见的内存容量远大于实际内存容量；



### 5.1.3 虚拟存储器的实现方法

​	都建立在离散分配存储管理方式的基础上！

1. 请求分页系统
   * 定义：在分页系统的基础上增加了请求调页功能和页面置换功能，所形成的虚拟存储系统；
   * 特点：以页为单位进行置换
2. 请求分段系统
   * 定义：在分段系统的基础上增加了请求调段功能和分段置换功能，所形成的虚拟存储系统；
   * 特点：以段为单位进行置换
3. 段页式虚拟存储系统



## 5.2 请求分页存储管理方式

​	请求分页系统 = 分页系统 + 请求调页功能  + 页面置换功能



### 5.2.1 请求分页中的硬件支持

1. 请求页表机制

   * 基本作用：将用户地址空间中的逻辑地址映射为内存空间中的物理地址；

   * 表项：

     * 页号：

     * 物理块号：

     * 状态位P：用于指示该页是否已调入内存；

     * 访问字段A：用于记录该页在一段时间内被访问的次数，提供给页面置换算法做参考；

     * 修改位M：标记该页在调入内存后是否被修改过；

       (若修改过，调出该页时必须将其重写到外存上；否则，不需要重写)

     * 外存地址：指出该页在外存上的地址，通常是物理块号；(与物理块号重复?)

2. 缺页中断机构

   * 过程：
     * 保护CPU环境；
     * 分析中断原因；
     * 转入缺页中断处理程序进行处理；
     * 中断处理完成后再恢复CPU环境；

   * 缺页中断与一般中断的区别：
     * 在指令执行期间产生中断信号(通常，CPU都是在一条指令执行完后，才检查是否有中断请求到达)
     * 一条指令在执行期间可能产生多次缺页中断；

3. 地址变换机构

   * (参考书P.158图5-2)



### 5.2.2 请求分页中的内存分配

1. 最小物理块数的确定
   * 最小物理块数：指能保证程序正常运行所需的最小物理块数，当系统位进程分配的物理块数少于此值时，进程将无法运行；
   * 有关条件：计算机的硬件结构、指令格式、寻址方式；
2. 内存分配策略
   * 固定分配局部置换(Fixed Allocation, Local Replacement)
     * 固定分配：指为某个进程分配一组固定数目的进程块，在进程运行期间不再改变；
     * 局部置换：如果在进程运行中发现缺页，则只能从分配给该进程的n个页面中选择一页换出，然后再调入一页，以保证分配给该进程的内存空间不变；
     * 困难：应为每个进程分配多少个物理块难以确定；
   * 可变分配全局置换(Variable Allocation, Global Replacement)
     * 可变分配：指先为每个进程分配一定数目的物理块，在运行期间可根据情况做适当的增加或减少；
     * 全局置换：若进程在运行时发生缺页，则在空闲物理块中取出一块分配给该进程；
   * 可变分配局部置换(Variable Allocation, Local Replacement)
     * 为每个进程分配一定数目的物理块，当发生缺页时，从该进程在内存的页面中选择一页换出，再调入一页；缺页率高时，增加分配给该进程的物理块；缺页率低时，减少分配给该进程的物理块；
3. 物理块分配算法
   * 平均分配算法：平均分配给各进程；
   * 按比例分配算法：根据各进程大小按比例分配；
   * 考虑优先权的分配算法：一部分按比例分配，一部分根据进程优先级分配；



### 5.2.3 页面调入策略

1. 何时调入页面

   * 预调页策略：
     * 做法：将那些预计在不久后会被访问的页面预先调入内存；
     * 特点：高效；成功率低(约50%)；
   * 请求调页策略：
     * 做法：当进程运行时需要访问某部分程序或数据，但发现其所在的页面不在内存时，提出请求，调入
     * 特点：易于实现；系统开销较大；

2. 从何处调入页面

   * 外存分为两部分：
     * 对换区(连续分配方式、存取速度高、空间利用率低)；
     * 文件区(离散分配方式、存取速度低、空间利用率高)；
   * 三种情况：
     * 对换区足够大：全部从对换区调入；
     * 对换区不够大：不会被修改的文件，从文件区调入；可能被修改的部分，从对换区调入；
     * UNIX方式：未运行过的页面，从文件区调入；运行过又被调出的页面，从对换区调入；

3. 页面调入过程(参考书P.162)

   * 发现要访问的页面不在内存(存在位为"0")，发出缺页中断；
   * 若内存未满，从外存调入所缺页；若内存已满，启动页面置换算法，选出一页准备换出；
   * 若该页未被修改，不必写回磁盘；若该页被修改，需写回磁盘；
   * 调入所缺页，置其存在位为"1"；

4. 缺页率

   * 缺页率：

     * 访问页面成功(即所访问页面在内存中)的次数为S；
     * 访问页面失败(即所访问页面不在内存中，需要从外存调入)的次数为F；
     * 该进程总的页面访问次数为A = S + F；
     * 缺页率：f = F / A；

   * 影响因素：

     * 页面大小：越大，缺页率越低；
     * 进程所分配物理块的数目：越多，缺页率越低；
     * 页面置换算法：缺页率是衡量页面置换算法的重要指标；
     * 程序固有特性：程序编制的局部化程度越高，缺页率越低；

   * 缺页中断处理时间：

     修改过的页面与未修改过的页面，缺页中断处理时间不同(修改过的要远远大于未修改过的)



## 5.3 页面置换算法

### 5.3.1 页面置换算法的定义与主要目标

1. 定义：把选择换出页面的算法称为页面置换算法(Page-Replacement Algorithms)；
2. 主要目标：应将那些以后不再会访问的页面换出，或把那些在较长时间内不会再访问的页面调出；
3. 抖动(Trashing)：刚被换出的页很快又要被访问，需要将它重新调入，以致一个进程在运行中把大部分时间都花费在页面置换工作上，我们称该进程发生了“抖动”；(不适当的页面置换算法可能导致进程发生“抖动”)



### 5.3.2 最佳置换算法和先进先出置换算法

1. 最佳(Optimal)置换算法
   * 做法：其所选择的被淘汰页面将是以后永不使用的，或许是在未来最长时间内不再被访问的页面；
   * 特点：
     * 具有最好的性能；
     * 因为无法预知将来，所以无法实现；
     * 通常作为标准，来评价其他算法的优劣；
2. 先进先出(FIFO)页面置换算法
   * 做法：总是淘汰最先进入内存的页面，即选择在内存中驻留时间最久的页面予以淘汰；
   * 特点：
     * 直观，易实现；
     * 因为与通常的页面使用规律不符，所以性能差；
     * 实际应用极少；



### 5.3.3 最近最久未使用和最少使用置换算法

1. 最近最久未使用LRU(Least Recently Used)置换算法
   * 描述：
     * 根据页面调入内存后的使用情况做出决策；
     * 因无法预知各页面将来的使用情况，用“最近的过去”作为“最近的将来”的近似；
     * 选择最近最久未使用的页面予以淘汰；
     * 每个页面有一个访问字段，用来记录一个页面自上次被访问以来所经历的时间t；
   * 硬件支持：(参考书P165)
     * 寄存器：移位寄存器
     * 栈：
2. 最少使用LFU(Least Frequently Used)置换算法
   * 实现：通过移位寄存器，原理与LRU寄存器实现相同；



### 5.3.4 Clock置换算法

1. 简单的Clock置换算法(LRU近似算法)

   * 又称为最近未使用算法NRU(Not Recently Used)；

   * 执行过程：

     (参考书p.166)

   * 特点：循环地检查各页面的使用情况

2. 改进型Clock置换算法

   * 改进的地方：同时考虑页面的使用情况与置换代价

     (修改过的页面在换出时，所付出的开销比未修改过的页面大)

   * 访问位A和修改位M，组合成四种类型的界面：

     (参考书p167)

   * 执行过程：

     (参考书p167)

   * 特点：

     * 可减少磁盘I/O次数；
     * 算法本身开销将有所增加(可能经过几轮扫描)；



### 5.3.5 页面缓冲算法(PBA, Page Buffering Algorithm)

1. 影响页面换入换出效率的因素
   * 页面置换算法
   * 写回磁盘的频率
   * 读入内存的频率
2. 页面缓冲算法PBA
   * 特点：
     * 实现简单，不需要特殊硬件的支持；
     * 显著降低了页面置换的频率，使磁盘I/O次数大为减少；
   * 内存分配策略：
     * 可变分配局部置换(系统为每个进程分配一定数目的物理块，系统自己保留一部分空闲物理块)
   * 数据结构：
     * 空闲页面链表：
       * 实质：空闲物理块链表
       * 作用：用于分配给频繁发生缺页的进程，以降低其缺页率
     * 修改页面链表：
       * 实质：由已修改页面所形成的链表
       * 作用：降低已修改页面写回磁盘的频率，降低将磁盘内容读入内存的频率
   * 执行过程：
     * 对每一个要被换出的页面(已修改)，系统可暂时不把它们写回磁盘，而是挂在修改页面链表上，仅当其数目达到一定值时，才将它们一起写回到磁盘上；(显著减少了磁盘的I/O次数)
     * 当要访问已修改列表中的页面时，直接从链表中获取，不需要从外存调入；



### 5.3.6 访问内存的有效时间EAT(Effective Access Time)

1. 被访问页在内存中，且其对应页表项在快表中：
   * EAT = 查找快表时间  + 访问实际物理地址时间
2. 被访问页在内存中，但其对应页表项不在快表中：
   * EAT = 查找快表时间 + 查找页表时间 + 修改快表时间 + 访问实际物理地址时间
3. 被访问页不在内存中：
   * EAT = 查找快表时间 + 查找页表时间 + 处理缺页中断时间 + 更新快表时间 + 访问实际物理地址时间
   * 考虑快表的命中率和缺页率：



## 5.4 抖动与工作集

### 5.4.1 多道程序度与“抖动”

1. 抖动(Trashing)：

   * 定义：刚被换出的页很快又要被访问，需要将它重新调入，以致一个进程在运行中把大部分时间都花费在页面置换工作上，我们称该进程发生了“抖动”；(不适当的页面置换算法可能导致进程发生“抖动”)

2. 多道程序度与处理机的利用率：

   参考书P.170 图5-9

3. 产生抖动的原因：

   * 根本原因：系统中同时运行的进程太多；
   * 分析：同时运行的进程太多，分配给每个进程的物理块太少，不能满足进程正常运行的需求，每个进程在运行时，频繁地出现缺页；



### 5.4.2 工作集

1. 工作集的基本概念

   (参考书P.170)

2. 工作集的定义

   * 定义1：指在某段时间间隔$\Delta$里，进程实际所要访问页面的集合；

   * 定义2：进程在时间间隔$(t-\Delta, t)$中引用页面的集合；
   * 性质：工作集与窗口尺寸$\Delta$有关，是$\Delta$的非降函数(nodecreasing function)；



### 5.4.3 抖动的预防方法

1. 采用局部置换策略
2. 把工作集算法融入到处理机调度中
3. 选择暂停的进程
4. 利用"L = S"准则调节缺页率
   * 基本概念：
     * L：缺页之间的平均时间
     * S：平均缺页服务时间，即置换一个页面所需时间
   * L = S 准则：
     * L < S：频繁发生缺页
     * L = S：刚好达到平衡，最大利用率
     * L > S：很少发生缺页
   * 特点：十分有效，应用广泛



## 5.5 请求分段存储管理方式

### 5.5.1 请求分段中的硬件支持

1. 请求段表机制

   * 段名
   * 段长
   * 段基址
   * 存在位P
   * 访问字段A
   * 修改位M
   * 外存始址
   * 存取方式：指示访问权限
   * 增补位：表示本段在运行过程中是否做过动态增长

2. 缺段中断机构

   (参考书P.174 图5-12)

3. 地址变换机构

   (参考书P.174 图5-13)



### 5.5.2 分段的共享与保护

1. 共享段表
   * 共享进程计数count
   * 存取控制字段
   * 段号
2. 共享段的分配与回收
   * 共享段的分配
   * 共享段的回收
3. 分段保护
   * 越界检查
   * 存取控制检查
   * 环保护机构

