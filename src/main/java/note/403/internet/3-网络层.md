[TOC]



# 第4章 网络层



## 4.1 网络层提供的两种服务

1. 问题：网络层应该向运输层提供怎样的服务？面向连接 or 无连接？

    (实质是：在计算机通信中，可靠交付应当由谁来负责？网络 or 端系统？)

2. 虚电路服务 & 数据报服务：

    (参考书P.115 表4-1)

3. 互联网的设计思路：

    * 网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务；

    * 若主机(即端系统)中的进程要求通信是可靠的，就由网络的主机中的运输层负责；

        (网络造价大大降低，运行方式灵活，能适应多种应用)



## 4.2 网际协议IP

### 4.2.1 网际协议IP及其配套协议

1. 关系图：

    (参考书P.115 图4-2)

2. 三个配套协议：

    * 地址解析协议ARP(Address Resolution Protocol)：
        * 作用：由IP地址得到MAC地址；
    * 网际报文控制协议ICMP(Internet Control Message Protocol)：
        * 作用：为了更有效地转发 IP 数据报和提高交付成功的机会；
    * 网际组管理协议IGMP(Internet Group Management Protocol)：
        * 作用：用于IP多播；



### 4.2.2 虚拟互联网络

1. 含义：使用 IP 协议，可以把异构的物理网络连接起来，使得在网络层看起来好像是一个统一的网络。

2. Note：

    * 互连起来的各物理网络的异构性是客观存在的，互联网可以由多种异构网络互连组成；

    * 若在覆盖全球的IP网络的上层使用TCP协议，就是现在的互联网；



### 4.2.3 IP地址及其表示方法

1. IP地址的概念：

    * 给互联网上的每一台主机(或路由器)的每一个接口分配一个在全世界范围内是唯一的32位标识符；

2. IP地址的编址方法共经历了三个历史阶段：

    * 分类：

        * 方法：由两部分组成，网络号和主机号，其中不同分类具有不同的网络号长度，并且是固定的；

        * 表示：IP 地址 ::= {< 网络号 >, < 主机号 >}

        * 五种不同的分类：

            (参考书P.119 图4-5)

        * 表示方法：点分十进制记法(dotted decimal notation)

            * 在32位的IP地址中，将每8位写成一个十进制数，用点隔开

            * 举例：

                ```C++
                100000000 00001011 00000011 00011111
                128.11.3.31
                ```

        * 分组转发：

            * 基本概念：
                * 路由表中包含所有目的网络的下一跳地址；

                    (路由表项：目的网络地址，下一跳地址)

                * 特定主机路由：对特定的目的主机指明一个路由；

                    (其余所有的分组转发都是基于目的主机所在的网络)

                * 默认路由：只要目的网络是其他网络，一律选择默认路由；

            * 流程：

                * 从IP数据报的首部提取出目的主机的IP地址D，得到目的网络的地址N；
                * 判断是否能直接交付；(若在同一局域网，就可以直接交付)
                * 判断是否有特定主机路由；
                * 查找路由表的每一项，看能否匹配；
                * 判断是否有默认路由；
                * 报告转发分组出错；

    * 子网划分：

        * 方法：通过在主机号字段中拿一部分作为子网号，把两级 IP 地址划分为三级 IP 地址；
        * 表示：IP 地址 ::= {< 网络号 >, < 子网号 >, < 主机号 >}；
        * 子网掩码(subnet mask)：
            * 目的：从IP地址得到子网地址；(只从IP地址无法看出是否进行了子网划分)
            * 表示：1对应网络号，0对应主机号；
            * 用法：将目的IP地址和子网掩码"按位与"，即可得到对应子网的网络地址；
            * Note：
                * 外部网络看不到子网的存在；
                * 不管网络有没有划分子网，只要将子网掩码和IP地址进行"按位与"就能得到网络地址；
                * 划分子网增加了灵活性，但却减少了能够连接在网络上的主机数；
                * 同样的IP地址和不同的子网掩码可以得到相同的网络地址，但不同掩码的效果不同；
            * 分组转发：(与分类编址相比，多了一个将目的地址D和子网掩码“按位与”的过程)
                * 从收到的IP数据报的首部提取出目的IP地址D；
                * 判断能否直接交付；
                * 判断是否有特定主机路由；
                * 对路由表中的每一项(目的网络地址，子网掩码，下一跳地址)，用目的地址D和子网掩码"按位与"，判断其结果是否与该行的目的网络地址相匹配；
                * 判断是否有默认路由；
                * 报告转发分组出错；

    * 无分类：

        * 全称：无分类域间路由选择CIDR(Classless Inter-Domain Routing)；

        * 方法：消除了传统 A 类、B 类和 C 类地址以及划分子网的概念，使用网络前缀和主机号来对 IP 地址进行编码，网络前缀的长度可以根据需要变化；

        * 表示：IP地址 ::= {<网络前缀>，<主机号>}

        * 表示方法：斜线记法(slash notation)

            * 在IP地址后面加上斜线"/"，然后写上网络前缀所占的位数；

            * 举例：

                ```C++
                128.14.35.7/20
                ```

        * 地址掩码(address mask)：

            * 与子网掩码类似，1表示网络号，0表示主机号；
            * 在斜线记法中，斜线后面的数字就是地址掩码中1的个数；

        * CIDR地址块：(CIDR地址块 = CIDR网络前缀 = 目的网络)

            * 定义：CIDR把网络前缀都相同的连续的IP地址组成一个"CIDR地址块"；
            * 表示：可用地址块中的最小地址和网络前缀的位数指明这个地址块；

            * 一个 CIDR 地址块中有很多地址，一个 CIDR 表示的网络就可以表示原来的很多个网络，并且在路由表中只需要一个路由就可以代替原来的多个路由，减少了路由表项的数量。把这种通过使用网络前缀来减少路由表项的方式称为路由聚合(route aggregation),也称构成超网(superneting)；

        * 最长前缀匹配(longest-prefix matching)：

            * 在路由表中的项目由“网络前缀”和“下一跳地址”组成，在查找时可能会得到不止一个匹配结果，应当采用最长前缀匹配来确定应该匹配哪一个；

                (因为网络前缀越长，其地址块就越小，因而路由就越具体)

        * 使用二叉线索查找路由表：

            * 二叉线索(binary trie)：一种特殊结构的树。IP地址从左到右的比特值决定了从根节点逐层向下延伸的路径，二叉线索中的各个路径就代表路由表中存放的各个地址；
            * 过程：
                * 先找出对应于每个IP地址的唯一前缀(unique prefix)；
                * 然后用这些前缀来构造二叉线索，每个叶结点代表一个唯一前缀；
                * 当搜索到一个叶结点时，必须将寻找匹配的目的地址和该叶结点的子网掩码进行"按位与"运算，判断能否匹配。若匹配，就按照下一跳的接口转发分组，否则就丢弃该分组；



### 4.2.4 IP数据报的格式

1. IP数据报的格式：

    (参考书P.128 图4-13)

2. IP数据报首部固定部分：

    * 版本：占4位，有4(IPv4)和6(IPv6)两个值；

    * 首部长度：占4位(可表示的最大十进制数是15)，单位是32位字(4字节)；

    * 区分服务：占8位，用来获得更好的服务(几乎没用过)；

    * 总长度：占16位，指首部和数据部分长度之和，单位是字节；(总长度<=MTU)

    * 标识(identification)：占16位。分片时，标识字段被复制到所有的数据报片的标识字段中，使得分片后的各数据报最后能正确地重装为原来的数据报；

    * 标志(flag)：占3位，目前只有前两位有意义。

        * MF(More Fragment)：MF = 1, 后面还有分片；MF = 0, 已经是最后一个分片；
        * DF(Don't Fragment)：DF = 1, 不能分片；DF = 0, 允许分片；

    * 片偏移：占13位，以8字节为单位。

        * 片偏移指出，较长的分组在分片后，某片分组在原分组的相对位置；

            (相对用户数据字段的起点，该片从何处开始)

    * 生存时间TTL(Time To Live)：占8位。

        * 目的：为了防止无法交付的数据报在互联网中不断兜圈子。(跳数限制)
        * 单位：路由器跳数，当 TTL 为 0 时就丢弃数据报。
        * 若将TTL设置为1，就表示这个数据报只能在本局域网中传送；

    * 协议：占8位。指出携带的数据应该上交给哪个协议进行处理(例如 ICMP、TCP、UDP 等)；

    * 首部检验和：占16位。

        * 只检验数据报的首部，不包括数据部分；
        * 数据报每经过一个路由器，都要重新计算检验和；
        * 检验方法：
            * 发送方：
                * 将数据报首部划分为许多个16位字序列，并将检验和字段置0；
                * 用反码算术运算将所有的16位字相加，将得到的和的反码写入检验和字段；
            * 接收方：
                * 将首部的所有16位字再使用反码算术运算相加一次，将得到的和取反码；
                * 若结果为0，则保留；否则，就丢弃该数据报；
        * 二进制反码算术运算：
            * 从低位到高位逐列进行：0+0=0；0+1=1；1+1=0，但要进位，加到下一列；
            * 若最高位相加后产生进位，则最后的结果要加1；

    * 源地址：占32位，发送方IP地址；

    * 目的地址：占32位，接收方IP地址；

3. IP数据报首部可变部分：

    * 很少使用，在IPv6中已经被废弃；





## 4.3 地址解析协议ARP

### 4.3.1 IP地址与硬件地址

1. IP地址：在IP数据报的首部，是逻辑地址；

2. 硬件地址：在MAC帧的首部，是物理地址，又称MAC地址；

3. 区别：

    参考书P.122 图4-8

4. Note：

    * 网络层实现主机之间的通信，而链路层实现具体每段链路之间的通信；(两台主机之间可以有很多条链路)
    * 在通信过程中，IP 数据报的源地址和目的地址始终不变，而 MAC 地址随着链路的改变而改变；



### 4.3.2 地址解析协议ARP

1. 作用：将IP地址转化为MAC地址；(用于同一局域网中的不同主机或路由器之间的通信，本地通信)

2. 原理：(参考书P.126 图4-11)

    * 每个主机都有一个 ARP 高速缓存，里面有本局域网上的各主机和路由器的 IP 地址到 MAC 地址的映射表
    * 广播发送ARP请求分组；
    * 单播发送ARP响应分组；

3. Note：

    * ARP对保存在高速缓存中的每一个映射地址项目都设置生存时间；

    * ARP是解决同一个局域网上的主机或路由器的IP地址和硬件地址的映射问题；

        (本地主机也不需要知道远程主机的硬件地址，它们之间的通信是通过连接它们的路由器进行)



## 4.4 网际控制报文协议ICMP

### 4.4.1 ICMP(Internet Control Message Protocol)概述

1. 目的：为了更有效地转发 IP 数据报和提高交付成功的机会；
2. 定位：封装在 IP 数据报中，但是不属于高层协议，是IP层协议；
3. 格式：(参考书P.147 图4-27)



### 4.4.2 ICMP报文的分类

(参考书P.148 表4-8)



1. 差错报告报文：
    * 分类：
        * 终点不可达：
        * 时间超过：
        * 参数问题：
        * 改变路由(重定向，Redirect)：
    * 格式：
        * ICMP差错报告报文的前8个字节+出错的IP数据报的首部和数据字段的前8个字节 = ICMP差错报告报文；(参考书P.149 图4-28)
    * 不发送ICMP差错报告报文的情况：
        * 对ICMP差错报告报文；
        * 对第一个分片的数据报片的所有后续数据报片；
        * 对具有多播地址的数据报；
        * 对具有特殊地址的数据报；(如127.0.0.0或0.0.0.0)

2. 询问报文：
    * 回送(Echo)请求或回答：
    * 时间戳(Timestamp)请求或回答：



### 4.4.3 ICMP应用

1. 分组网间探测PING(Packet InterNet Groper)：

    * 作用：用来测试两台主机之间的连通性；

    * Note：

        * ping使用了ICMP回送请求与回送回答报文；
        * ping是应用层直接使用网络层ICMP的一个例子，它没有通过运输层的TCP或UDP；

    * 过程：

        * 发送方：发送回送请求报文；

        * 接收方：发送回送回答报文；

            (根据往返的ICMP报文上的时间戳，很容易算出往返时间)

    * 举例：

        ```
        ping hostname(or IP address)
        ```

2. traceroute：

    * 作用：用来跟踪一个分组从源点到终点的路径；

    * 过程：

        * 源主机向目的主机发送一连串的 IP 数据报。数据报封装的是无法交付的 UDP 用户数据报(使用了非法端口)，最后由目的主机发送终点不可达差错报告报文；
        * 第一个数据报 P1 的生存时间 TTL 设置为 1，当 P1 到达路径上的第一个路由器 R1 时，R1 收下它并把 TTL 减 1，此时 TTL 等于 0，R1 就把 P1 丢弃，并向源主机发送一个 ICMP 时间超过差错报告报文；
        * 源主机接着发送第二个数据报 P2，并把 TTL 设置为 2。P2 先到达 R1，R1 收下后把 TTL 减 1 再转发给 R2，R2 收下后也把 TTL 减 1，由于此时 TTL 等于 0，R2 就丢弃 P2，并向源主机发送一个 ICMP 时间超过差错报文。
        * 不断执行这样的步骤，直到最后一个数据报刚刚到达目的主机，主机不转发数据报，也不把 TTL 值减 1。但是因为数据报封装的是无法交付的 UDP，因此目的主机要向源主机发送 ICMP 终点不可达差错报告报文；
        * 之后源主机知道了到达目的主机所经过的路由器 IP 地址以及到达每个路由器的往返时间；

    * Note：

        * 有可能经过更多的路由器反而花费更少的时间；

            (因为互联网的拥塞程度随时都在变化，也难以预料)



## 4.5 路由器

### 4.5.1 路由器的构成

1. 路由器从功能上划分为两大部分：路由选择 & 分组转发；

2. 典型的路由器的结构：

    (参考书P.167 图4-42,43,44)

3. 路由选择：

    - 任务：更新和维护路由表；

4. 分组转发：

    - 任务：转发分组；
    - 构成：交换结构 + 一组输入端口 + 一组输出端口；



### 4.5.2 路由器分组转发流程

1. 流程：(参考书P.134 图4-17)
    * 从数据报的首部提取目的主机的 IP 地址 D，得到目的网络地址 N；
    * 若 N 就是与此路由器直接相连的某个网络地址，则进行直接交付；
    * 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给表中所指明的下一跳路由器；
    * 若路由表中有到达网络 N 的路由，则把数据报传送给路由表中所指明的下一跳路由器；
    * 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；
    * 报告转发分组出错；



### 4.5.3 路由选择协议

1. 概述：

    * 自制系统AS(Autonomous System)：
        - 定义：在单一技术管理下的一组路由器；
        - 特点：
            - 一个AS对其他AS表现出的是一个单一的和一致的路由选择策略；
            - 互联网可划分为许多小的自治系统 AS，一个 AS 可以使用一种和别的 AS 不同的路由选择协议；
    * 路由选择协议：
        * 核心：路由算法，即需要何种算法来获得路由表中的各项目；
        * 分类：
            * 内部网关协议IGP(Interior Gateway Protocol)：自治系统内部的路由选择；(RIP, OSPF等)
            * 外部网关协议EGP(External Gateway Protocol)：自治系统间的路由选择；(BGP)

2. 内部网关协议RIP(Routing Information Protocol，路由信息协议)：

    * 概述：

        * RIP是一种分布式的基于距离向量的路由选择协议；
        * RIP要求网络中每一个路由器都要维护从它自己到其他每一个目的网络的距离纪录；
        * RIP中的距离指跳数(hop count)：
            * 直接相连的路由器跳数为1；
            * 从一路由器到非直接连接的网络的距离为所经过的路由器数加1；
            * 跳数最多为15(超过 15 表示不可达)；
        * RIP不能在两个网络之间同时使用多条路由。RIP选择一条具有最少路由器的路由(最短路由)，哪怕还存在另一条高速(低时延)但路由器较多的路由；
        * RIP的路由表更新原则：找出到每个目的网络的最短距离；

    * 特点：(和哪些路由器交换信息？交换什么信息？在什么时候交换信息？)

        * 仅和相邻路由器交换信息，不相邻路由器不交换信息；

        * 路由器交换的信息是当前本路由器所知道的全部信息，即自己现在的路由表；

            (我到本自制系统中所有网络的最短距离，以及到每个网络的要经过的下一跳路由器)

        * 按固定的时间间隔交换路由信息；

        * (经过若干次交换之后，所有路由器最终会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器地址)；

    * 距离向量算法：(参考书P.155)

        * 对地址为X的相邻路由器发来的RIP报文，先修改报文中的所有项目，把下一跳字段中的地址改为X，并把所有的距离字段加1，此时每个项目都有三个关键数据(到目的网络N，距离是d，下一跳是X)；
        * 对修改后的RIP报文中的每一个项目，进行以下步骤：
            * 若原来的路由表中没有目的网络N，则把该项目添加到路由表中；
            * 否则(即在路由表中有目的网络N，这时就再查看下一跳路由器地址)
                * 若下一跳路由器地址是X，则把收到的项目替换原来路由表中的项目；
                * 否则(即这个项目是：到目的网络N，下一跳路由器不是X)
                    * 若收到的项目中的距离 d 小于路由表中的距离，则进行更新；
                    * 否则什么也不做；
        * 若3分钟还没有收到相邻路由器的更新路由表，则把该相邻路由器标为不可达，即把距离置为16；
        * Bellman-Ford算法：

    * 报文格式：

        * RIP协议使用运输层的用户数据报UDP进行传送；(使用UDP的端口520)
        * (参考书P.157 图4-32)

    * 优缺点：

        * 优点：
            * 实现简单，开销小；
            * 好消息传播得快(如果一个路由器发现了较短的路由，这种更新信息传播得很快)；
        * 缺点：
            * 限制了网络规模(能使用的最大距离为15)；
            * 开销较大(路由器交换的是完整路由表)；
            * 坏消息传播得慢(网络若出现故障需要较长的时间传播)；

3. 内部网关协议OSPF(Open Shorest Path First，开放最短路径优先)：

    * 概述：
        * OSPF使用分布式的链路状态协议(link state protocol)；
        * 链路状态：本路由器和哪些路由器相邻，以及该链路的度量(如费用、距离、时延、带宽等)；
    * 特点：(和哪些路由器交换信息？交换什么信息？在什么时候交换信息？)
        * 和本自制系统中的所有路由器交换信息(洪泛法，flooding)；
        * 交换的信息是与本路由器相邻的所有路由器的链路状态；
        * 只有当链路状态发生改变时，才用洪泛法交换信息；
        * (最终所有的路由器都能建立一个链路状态数据库，即全网的拓扑结构图，并且是一致的。每个路由器使用链路状态数据库构造出自己的路由表。)
    * 报文格式：
        * OSPF不用UDP而是直接使用IP数据报传送；
        * (参考书P.161 图4-35)
    * 优缺点：
        * 相比于 RIP，OSPF 的更新过程收敛的很快；

4. 外部网关协议BGP(Border Gateway Protocol，边界网关协议)：

    * 概述：(参考书P.165 图4-38ß)
        * BGP只能寻找一条比较好的路由，而不是最佳路由；
        * 每个AS都必须配置BGP发言人，通过在两个相邻BGP发言人之间建立TCP连接来交换路由信息；
    * AS之间路由选择困难的原因：
        * 互联网规模很大；
        * 各个AS内部使用不同的路由选择协议，无法准确定义路径的度量；
        * AS之间的路由选择必须考虑有关的策略，比如有些AS不愿意让其它AS经过；



## 4.6 虚拟专用网/网络地址转换

### 4.6.1 虚拟专用网VPN(Virtual Private Network)

1. 专用地址(private address)：

    * 目的：由于IP地址的紧缺，一个机构能申请到的IP地址数往往远小于本机构所拥有的主机数。并且一个机构并不需要把所有的主机接入到外部的互联网中，机构内的计算机可以使用仅在本机构有效的IP地址(专用地址)；
    * 三个专用地址块：
        * 10.0.0.0 ~ 10.255.255.255
        * 172.16.0.0 ~ 172.31.255.255
        * 192.168.0.0 ~ 192.168.255.255

2. 虚拟专用网VPN：

    * 定义：使用公用的互联网作为本机构各专用网之间的通信载体，这样的专用网又称为VPN；

    * 专用&虚拟：

        * 专用：专用指机构内的主机只与本机构内的其它主机通信；
        * 虚拟：虚拟指好像是，而实际上并不是，它有经过公用的互联网；

    * 举例：

        (参考书P.186 图4-59)



### 4.6.2 网络地址转换NAT(Network Address Translation)

1. NAT(Network Address Translation)：

    * 专用网内部的主机使用本地IP地址又想和互联网上的主机通信时，可使用NAT来将本地IP转换为全球IP；

    * 互联网上的路由器都不转发目的地址是专用网本地IP地址的IP数据报；
    * NAT将本地IP和全球IP一一对应，这种方式下拥有n个全球IP地址的专用网内最多只可以同时有n台主机接入互联网；

2. NAPT(Network Address and Port Translation)：

    * 为了更有效地利用全球IP地址，现在常用的NAT转换表把传输层的端口号也用上了，使得多个专用网内部的主机共用一个全球IP地址。使用端口号的NAT也叫做网络地址与端口转换NAPT；



## 4.7 IPv6/IP多播/多协议标记交换MPLS

### 4.7.1 IPv6



### 4.7.2 IP多播



### 4.7.3 多协议标记交换MPLS(MultiProtocol Label Switching)

