[TOC]

# 第三章 数据链路层



## 3.1 数据链路层概述

### 3.1.1 数据链路层讨论的问题：

1. 在同一个局域网中，分组(帧)怎样从一台主机传送到另一台主机，但并不经过路由器转发；

   (网络层讨论的问题是多个网络互连的问题，即分组怎样从一个网络，通过路由器，转发到另一个网络)



### 3.1.2 链路 & 数据链路：

1. 链路：一个结点到相邻结点的一段物理线路；
2. 数据链路：在链路的基础上增加了一些必要的硬件(如网络适配器等)和软件(如协议的实现)；



### 3.1.3 数据链路层的信道分类：

1. 点对点信道(一对一)：PPP协议；
2. 广播信道(一对多)：CSMA/CD协议；



### 3.1.4 数据链路层的三个基本问题：

1. 封装成帧：
   * 做法：将网络层传下来的分组添加帧首部和帧尾部，用于标记帧的开始和结束；
   * 相关概念：
     * 最大传输单元MTU(Maximum Transfer Unit)：帧的数据部分长度上限；
     * 帧定界符：
         * SOH(Start Of Head)：表示帧的首部开始；
         * EOT(End Of Transmission)：表示帧的结束；

2. 透明传输：
   * “透明”的含义：实际存在的事物(转义字符)看起来好像不存在一样；
   * 问题：如果数据部分出现帧定界符，将导致数据链路层错误地找到帧的边界；
   * 解决办法：
     * 字符填充(character stuffing)：在控制字符(SOH或EOT)和转义字符前插入转义字符；

3. 差错检测：

   * 差错分类：
     * 比特差错：0变1，1变0；
     * 传输差错：帧丢失、帧失序、帧重复；

   * 误码率BER(Bit Error Rate)：一段时间内，传输错误的比特占传输比特总数的比率；

   * 循环冗余检验CRC(Cyclic Redundancy Check)：

     * 原理：
       * 在数据M后面添加n位冗余码，供差错检测用；
       * n位冗余码的获得方法：将发送的帧除以除数P(模2运算)，得到余数R；
       * 余数R，作为冗余码，拼接在数据M的后面发出去；
       * 冗余码又称帧检验序列FCS(Frame Check Sequence)；
       * 将接收的帧除以同样的除数P(模2运算)，然后检查得到的余数R：
         * R = 0，帧没差错，接收；
         * R != 0，帧有差错，丢弃；
     * Note：
         * CRC仅提供检错功能，不提供纠错功能，并且只能检测出比特差错；
         * CRC与FCS不是同一个概念，CRC是一种检错方法，FCS是添加在数据后面的冗余码；



## 3.2 点对点信道

### 3.2.1 主要步骤：

1. 结点A的数据链路层把网络层交下来的IP数据报添加首部和尾部封装成帧；
2. 结点A把封装好的帧发送给结点B的数据链路层；
3. 若结点B的数据链路层收到的帧无差错(CRC)，则从中提取出IP数据报交给上面的网络层；否则，丢弃该帧；



### 3.2.2 PPP协议(Point to Point Protocol)

1. 用途：互联网用户通常都需要连接到某个ISP才能接入到互联网，PPP协议就是用户计算机和ISP进行通信时所使用的数据链路层协议；
2. 特点：
   * 只支持用CRC进行检错，不支持纠错；
   * 只支持点对点通信，不支持多点通信；
   * 只支持全双工链路；
3. PPP协议的帧格式：(参考书P.79 图3-10)
   * 各字段的意义：
     * F字段为帧定界符；
     * A(地址字段)、C(控制字段)字段暂时没有意义；
     * FCS字段是使用CRC的帧检验序列；
     * 信息部分长度不超过1500字节；
   * 字节填充：
     * 异步传输时，采用字节填充(在控制字符和转义字符前填入转义字符)；
     * 同步传输时，采用零比特填充(只要发现5个连续的1，立即填入一个0)；
4. PPP协议的工作状态：(参考书P.81 图3-12)
   * 链路静止(Link Dead)
   * 链路建立(Link Establish)
   * 鉴别(Authenticate)
   * 网络层协议(Network-Layer protocol)
   * 链路打开(Link Open)
5. Note：
   * PPP协议已不是纯粹的数据链路层协议，还包含了物理层和网络层的内容；



## 3.3 广播信道

### 3.3.1共享信道的两种方法：

1. 静态划分：频分复用、时分复用、波分复用、码分复用等；

2. 动态划分：又称多点接入(Multiple Access)
   * 随机接入：会产生碰撞，必须要有解决碰撞的网络协议；
   * 受控接入：探询(polling)；



### 3.3.2 CSMA/CD协议

1. CSMA/CD(Carrier Sense Multiple Accesss Collision Detection)要点：
   * 多点接入：说明这是总线型网络，许多主机以多点的方式连接到总线上；
   * 载波监听：每个主机都必须不停地监听信道。在发送前，如果监听到信道正在使用，就必须等待；
   * 碰撞检测：在发送中，如果监听到信道已有其它主机正在发送数据，就表示发生了碰撞。虽然每个主机在发送数据之前都已经监听到信道为空闲，但是由于电磁波的传播时延的存在，还是有可能会发生碰撞；
2. Note：
   * 记端到端的传播时延为 τ，最先发送的站点最多经过 2τ 就可以知道是否发生了碰撞，称 2τ 为 **争用期** 。只有经过争用期之后还没有检测到碰撞，才能肯定这次发送不会发生碰撞；
   * 当发生碰撞时，站点要停止发送，等待一段时间再发送。这个时间采用 **截断二进制指数退避算法** 来确定。从离散的整数集合 {0, 1, .., (2k-1)} 中随机取出一个数，记作 r，然后取 r 倍的争用期作为重传等待时间；
   * 一个站不可能同时发送和接受(但必须边发送边监听信道)，因此使用CSMA/CD协议的局域网只能进行半双工通信而非全双工通信；



### 3.3.3 局域网

1. 特点：

   * 是一种典型的广播信道；
   * 网络为一个单位所拥有，且地理范围和站点数目均有限；

2. 主要类型：

   * 以太网；

   * 令牌环网；

   * FDDI；

   * ATM ；

     (Note：目前以太网占领了绝大部分的局域网市场，所以以太网几乎成了局域网的同义词)

3. 按照网络拓扑结构进行分类：

   * 星型网；
   * 环形网；
   * 总线网；



### 3.3.4 以太网

1. 特点：

   * 以太网是一种星型拓扑结构局域网；
   * 早期使用总线进行连接，后来发展到使用集线器进行连接，目前以太网使用交换机替代了集线器；

2. 以太网的MAC层：

   * MAC地址(物理地址)：

     * MAC 地址是链路层地址，长度为 6 字节(48 位)，用于唯一标识网络适配器(网卡)；

       (一台主机拥有多少个网络适配器就有多少个 MAC 地址。例如笔记本电脑普遍存在无线网络适配器和有线网络适配器，因此就有两个 MAC 地址。)

   * MAC帧格式：(参考书P.96 图3-22)

     * 类型：标记上层使用的协议；
     * 数据：长度在46-1500字节之间，如果太短则需要填充；
     * FCS：使用CRC的帧检测序列；



### 3.3.5 虚拟局域网

1. 作用：可以建立与物理位置无关的逻辑组，只有在同一个虚拟局域网中的成员才会收到链路层广播信息；
2. 举例：(参考CYC笔记)
3. 帧格式：扩展的以太网帧格式 802.1Q(参考书P.103 图3-28)
   * 在标准以太网帧的首部上加了 4 字节 VLAN 标记，用于表示该帧属于哪一个虚拟局域网；



### 3.3.6 几种重要的硬件

1. 适配器(adapter)：又称网卡(网络接口卡NIC, Network Interface Card)

   * 特点：工作在物理层和数据链路层；
   * 作用：
     * 进行数据串行传输(适配器和局域网之间的通信)和并行传输(适配器和计算机之间的通信)的转换；
     * 存储计算机的硬件地址于自己的ROM中；
   * 工作原理：(参考书P.85 图3-15)

2. 集线器(hub)：

   * 特点：
     * 工作在物理层；
     * 作用于比特而不是帧；
   * 广播发送；
     
   * 工作原理：
     * 当一个比特到达接口时，集线器重新生成这个比特，并将其能量强度放大，从而扩大网络的传输距离，之后再将这个比特发送到其它所有接口。如果集线器同时收到两个不同接口的帧，那么就发生了碰撞；

3. 交换机(switch)：又称网桥(bridge)

   * 特点：
     * 工作在数据链路层；
     * 单播发送；
     * 具有自学习能力，学习的是交换表的内容，交换表中存储着 MAC 地址到接口的映射；
     * 正是由于这种自学习能力，因此交换机是一种即插即用设备，不需要网络管理员手动配置交换表内容
   * 举例：(参考CYC笔记)

